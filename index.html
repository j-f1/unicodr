<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="index.css" charset="utf-8">
    <script>
      window.$ = window.jQuery = require('jquery');
    </script>
    <script src="iscroll-infinite.js" charset="utf-8"></script>
    <script>
      window.IScroll = module.exports;
    </script>
  </head>
  <body>
    <header>
      <input class="search" placeholder="Search charactersâ€¦">
    </header>
  </body>

  <div class="loader">
    <div class="spinner"></div>
    <p>Loading&hellip;</p>
    <div class="progress"></div>
  </div>

  <div id="wrapper">
  	<main id="scroller">
      <ul>
        <li class="row">
          <span class="item">
            <span class="char"></span>
            <span class="code"></span>
            <span class="note">Click to copy</span>
          </span>
        </li>
      </ul>
    </main>
  </div>
  <script>
    // You can also require other files to run in this process
    // This file is required by the index.html file and will
    // be executed in the renderer process for that window.
    // All of the Node.js APIs are available in this process.

    const promisify = require('promisify-node');
    const python = promisify(require('python').shell);
    const path = require('path');
    const fs = promisify(require('fs'));

    class UniChar {
      constructor({name, code}) {
        this.name = name;
        this.code = code;
        this.char = String.fromCharCode(code);
      }
      get prettyCode() {
        var code = this.code.toString(16);
        while (code.length < 4) {
          code = "0" + code;
        }
        return "U+" + code;
      }
      get HTML() {
        $el = $(this.constructor.tmpl);
        return this.fill$View($el);
      }
      fill$View($view) {
        $view.each(function(i, el) {
          this.fillView(el);
        });
      }
      fillView(view) {
        view.querySelector('.char').textContent = this.char;
        view.querySelector('.code').textContent = this.prettyCode;
        view.title = this.name.toLowerCase();
        return view;
      }
    }

    {
      let row = $('.row');
      let cell = row.children();
      for (var i = 1; i < 5  ; i++) {
        cell.clone().appendTo(row);
      }
      for (var i = 1; i < 100; i++) {
        row.clone().appendTo($('ul'));
      }
    }

    var loadUnicodeData = new Promise(function(resolve, reject) {
      let UNICODE_DATA = [];
      fs.readFile(path.join(__dirname, 'load.py'), 'utf-8').then(pythonCode => {
        $('.loader p').html('Building&hellip;');
        python(pythonCode).then(json => {
          json = json.replace(/^Command Start\n/, '');
          var data = JSON.parse(json);
          data.forEach(charInfo => {
            let char = new UniChar(charInfo);
            UNICODE_DATA.push(char);
          });
          resolve(UNICODE_DATA);
        });
      }, err => {
        reject(err);
      });
    });
    loadUnicodeData.then(data => {
      window.UNICODE_DATA = data;
      var rows = [];
      for (var i = 0; i < UNICODE_DATA.length; i++) {
        if (i % 5 === 0) {
          rows.push([]);
        }
        rows[rows.length-1].push(UNICODE_DATA[i]);
      }
      $('.loader p').html('Creating&hellip;');
      var scroller = new IScroll("#wrapper", {
        mouseWheel: true,
        infiniteElements: 'main .row',
        disableMouse: true,
        disablePointer: true,
        dataset: (start, count) => {
          setTimeout(() => {
            scroller.updateCache(start, rows.slice(start, count));
          });
        },
        dataFiller: (el, data) => {
          $(el).children().each((i, el) => {
            data[i].fillView(el);
          });
        },
        cacheSize: 10000
      });
      setTimeout(() => {
        $('body').addClass('ready');
      }, 100);
      $('.loader').remove();
    }, err => {throw err;});


    const {clipboard, remote} = require('electron');
    window.currentBrowserWindow = remote.getCurrentWindow();

    currentBrowserWindow.on('enter-full-screen', () => {
      $('html').addClass('fullscreen');
    });
    currentBrowserWindow.on('leave-full-screen', () => {
      $('html').removeClass('fullscreen');
    });

    $('html').toggleClass('fullscreen', currentBrowserWindow.isFullScreen());

    $('main').click('.char', (event) => {
      clipboard.writeText(event.target.innerHTML);
    });
  </script>
</html>
