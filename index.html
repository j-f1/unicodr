<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="index.css" charset="utf-8">
    <script>
      window.$ = window.jQuery = require('jquery');
    </script>
    <script src="infinity.js" charset="utf-8"></script>
  </head>
  <body>
    <header>
      <input class="search" placeholder="Search charactersâ€¦">
    </header>
  </body>

  <div class="loader">
    <div class="spinner"></div>
    <p>Loading&hellip;</p>
    <div class="progress"></div>
  </div>

  <main></main>

  <script>
    // You can also require other files to run in this process
    // This file is required by the index.html file and will
    // be executed in the renderer process for that window.
    // All of the Node.js APIs are available in this process.

    const promisify = require('promisify-node');
    const python = promisify(require('python').shell);
    const path = require('path');
    const fs = promisify(require('fs'));

    class UniChar {
      constructor({name, code}) {
        this.name = name;
        this.code = code;
        this.char = String.fromCharCode(code);
      }
      get prettyCode() {
        var code = this.code.toString(16);
        while (code.length < 4) {
          code = "0" + code;
        }
        return "U+" + code;
      }
    }

    var loadUnicodeData = new Promise(function(resolve, reject) {
      let UNICODE_DATA = [];
      fs.readFile(path.join(__dirname, 'load.py'), 'utf-8').then(pythonCode => {
        $('.loader p').html('Building&hellip;');
        python(pythonCode).then(json => {
          json = json.replace(/^Command Start\n/, '');
          var data = JSON.parse(json);
          data.forEach(charInfo => {
            let char = new UniChar(charInfo);
            UNICODE_DATA.push(char);
          });
          resolve(UNICODE_DATA);
        });
      }, err => {
        reject(err);
      });
    });
    loadUnicodeData.then(data => {
      $('.loader p').html('Creating&hellip;');

      setTimeout(() => {
        window.UNICODE_DATA = data;
        let _cursor = 5;
        let lazy = function ($page) {
          var $row = $('<div class="row">');
          for (var i = 0; i < 5; i++) {
            let char = UNICODE_DATA[_cursor + i],
            $el = $(tmpl);
            $el.children('.char').text(char.char);
            $el.children('.code').text(char.prettyCode);
            $el.attr('title', char.name.toLowerCase());
            $row.append($el);
          }
          $page.appendChild($row[0]);
          _cursor += 5;
        };
        var $main = $('main'),
            $list = new infinity.ListView($main, {lazy}),
            $row,
            tmpl = `<span class="item">
            <span class="char"></span>
            <span class="code"></span>
            </span>`.replace(/>\s+</, '><'),
            $bar = $('.loader .progress');
            window.$list = $list;
        for (var i = 0; i < 5; i++) {
          if (i % 5 === 0) {
            if ($row) $list.append($row);
            $row = $('<div class="row">');
          }
          // if (i % 100 === 0) {
          //   $bar.css('width', i/max + 'vw');
          // }
          let char = UNICODE_DATA[i],
          $el = $(tmpl);
          $el.children('.char').text(char.char);
          $el.children('.code').text(char.prettyCode);
          $el.attr('title', char.name.toLowerCase());
          $row.append($el);
        }
        $('.loader p').html('Displaying&hellip;');
        $('.loader').remove();
      }, 50);
    }, err => {throw err;});
  </script>
</html>
